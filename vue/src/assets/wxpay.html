<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">

  <!--for mobile web app-->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000"><!-- Chrome, Firefox OS and Opera -->
  <meta name="msapplication-navbutton-color" content="#000"><!-- Windows Phone -->

  <title>微信支付</title>

  <!-- for trackjs: must put in head tag -->
  <script type="text/javascript">
    var token = '_REPL_TRACKJS_TOKEN_';
    if (token.indexOf('_REPL_') != 0) {
      window._trackJs = { token: token };
    }
  </script>
  <script type="text/javascript" src="https://oe5u0e10o.qnssl.com/trackjs.com/tracker.js"></script>
  <script type="text/javascript">
    function readCookie(name) {
      var nameEQ = encodeURIComponent(name) + "=";
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) === ' ') {
          c = c.substring(1, c.length);
        }if (c.indexOf(nameEQ) === 0) return decodeURIComponent(c.substring(nameEQ.length, c.length));
      }
      return '';
    }
    function serializeObj(source) {
      var kvArr = source.split('&');
      var target = {};
      for (var _iterator = kvArr, _isArray = Array.isArray(_iterator), _i = 0, _iterator = _isArray ? _iterator : _iterator[Symbol.iterator]();;) {
        var _ref;

        if (_isArray) {
          if (_i >= _iterator.length) break;
          _ref = _iterator[_i++];
        } else {
          _i = _iterator.next();
          if (_i.done) break;
          _ref = _i.value;
        }

        var kv = _ref;

        var kvPair = kv.split('=');
        if (kvPair.length === 2) target[decodeURIComponent(kvPair[0])] = decodeURIComponent(kvPair[1]);
      }
      return target;
    }

    var userCookie = readCookie('_cur_user');
    var userObj = serializeObj(userCookie);
    var uid = userObj['uid'];
    var sessCookie = readCookie('_sess');
    var sessObj = serializeObj(sessCookie);
    var sessId = sessObj['v'];
    if (window.trackJs && uid) window.trackJs.configure({ userId: uid });
    if (window.trackJs && sessId) window.trackJs.configure({ sessionId: sessId });
  </script>

  <!-- for ga: must put in head tag -->
  <script type="text/javascript">
    var dataLayer = dataLayer || [];
    var gaid = '_REPL_GAID_';
    if (gaid.indexOf('_REPL_') == 0) {
      gaid = 'UA-75377537-3';
    }
    dataLayer.push({
      'gaid': gaid,
      'version': ''
    });
  </script>
  <script>
    (function (w, d, s, l, i) {
      w[l] = w[l] || [];
      w[l].push({
        'gtm.start': new Date().getTime(), event: 'gtm.js'
      });
      var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : '';
      j.async = true;
      j.src =
        'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
      f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-TZQHFKM');
  </script>
  <!-- End Google Tag Manager -->
</head>
<body>
  <!-- Google Tag Manager (noscript) -->
  <noscript>
    <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TZQHFKM"
            height="0" width="0" style="display:none;visibility:hidden"></iframe>
  </noscript>
  <!-- End Google Tag Manager (noscript) -->

  <style>
    .paying {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .icon {
      width: 100px;
      height: 83px;
      fill: #c3c3c3;
    }

    .tips {
      margin-top: 20px;
      color: #4B4B4B;
      font-size: 16px;
    }

    #backtoLink {
      color: #31B5A5;
      font-size: 16px;
      text-decoration: none;
    }

    #backtoLink:hover {
      text-decoration: underline;
    }

    .invalid {
      width: 100vw;
      height: 100vh;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #4B4B4B;
    }
  </style>
  <div id="paying" class="paying">
    <svg t="1504760155864" class="icon" style="" viewBox="0 0 1256 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2488" xmlns:xlink="http://www.w3.org/1999/xlink" width="245.3125" height="200"><defs><style type="text/css"></style></defs><path d="M876.275308 315.158485c6.299427 0 12.505299 0.062371 18.742356 0.405409C862.179559 136.809843 677.562675 0 454.681447 0 208.629553 0 9.199659 166.810086 9.199659 372.570593c0 120.655866 68.545255 227.902059 174.85589 295.979535 1.372153 0.873188 4.085272 2.588379 4.085272 2.588379l-43.035693 134.813985 161.040809-82.017298c0 0 5.052016 1.434523 7.578024 2.18297 44.251919 12.349373 91.684736 18.991838 140.957486 18.991838 10.041662 0 20.052138-0.374223 29.937873-0.904373-9.137288-28.347424-14.158119-58.12937-14.158119-88.878061C470.461201 467.436229 652.209039 315.158485 876.275308 315.158485zM609.734681 183.712511c34.52211 0 62.526495 27.100012 62.526495 60.530637 0 33.430625-27.9732 60.593008-62.526495 60.593008-34.58448 0-62.557681-27.162383-62.557681-60.593008C547.177001 210.781338 575.119016 183.712511 609.734681 183.712511zM299.659398 304.836155c-34.553295 0-62.557681-27.162383-62.557681-60.593008 0-33.46181 27.9732-60.530637 62.557681-60.530637s62.620051 27.100012 62.620051 60.530637C362.279449 277.673773 334.243879 304.836155 299.659398 304.836155z" p-id="2489"></path><path d="M503.236935 657.510537c0 173.857961 168.556462 314.784261 376.406383 314.784261 41.601169 0 81.67426-5.675722 119.034231-16.122792 2.151785-0.59252 6.424169-1.839932 6.424169-1.839932l135.999025 69.356073-36.362042-113.951029c0 0 2.307711-1.434523 3.430381-2.18297 89.813619-57.505665 147.724692-148.098916 147.724692-250.074796 0-173.79559-168.494092-314.721891-376.281642-314.721891C671.793397 342.788647 503.236935 483.714947 503.236935 657.510537zM957.731271 549.079303c0-28.191497 23.638446-51.112681 52.796687-51.112681 29.251797 0 52.859057 22.889999 52.859057 51.112681 0 28.316238-23.638446 51.268608-52.859057 51.268608C981.369716 600.316726 957.731271 577.395541 957.731271 549.079303zM695.806067 549.079303c0-28.191497 23.700816-51.112681 52.859057-51.112681 29.220612 0 52.859057 22.889999 52.859057 51.112681 0 28.316238-23.669631 51.268608-52.859057 51.268608C719.475697 600.316726 695.806067 577.395541 695.806067 549.079303z" p-id="2490"></path></svg>
    <div class="tips">正在唤起微信支付, 点击 <a id="backtoLink" href="">此处</a> 返回</div>
  </div>
  <div id="invalid" class="invalid">
    无效请求
  </div>
  <script>
    var req, backto, backtoLink, wxPayReq;

    var showInvalidBlock = function () {
      document.getElementById('paying').style.display = 'none';
      document.getElementById('invalid').style.display = 'flex';
    };

    var getBackLink = function (url, result) {
      var aEle = document.createElement('a');
      aEle.href = url;
      var queryStr = aEle.search.replace('?', '');
      var queryArr = queryStr ? queryStr.split('&') : [];
      var queryObj = {};

      for (var i=0; i<queryArr.length; i++) {
        var kv = queryArr[i];
        var kvArr = kv.split('=');
        queryObj[kvArr[0]] = kvArr[1];
      }

      if (result) queryObj['payResult'] = result;

      var queryResultArr = [];
      var queryResultStr = '';
      for (var k in queryObj) {
        var v = queryObj[k];
        if ('' + v !== 'undefined') {
          queryResultArr.push(k + '=' + v);
        }
      }

      if (queryResultArr.length) queryResultStr = queryResultArr.join('&');

      aEle.search = '?' + queryResultStr;

      return aEle.href;
    };

    try {
      req = location.search.split('&')[0].split('=')[1];
      backto = decodeURIComponent(location.search.split('&')[1].split('=')[1]);
      backtoLink = getBackLink(backto);
      wxPayReq = JSON.parse(decodeURIComponent(req));
    } catch (e) {
      showInvalidBlock();
      throw e;
    }

    if (backtoLink.indexOf(location.protocol + '//' + location.host) === -1) {
      showInvalidBlock();
    }

    document.getElementById('backtoLink').addEventListener('click', function (e) {
      location.replace(backtoLink);
      e.preventDefault();
    }, false);

    function onBridgeReady() {
      WeixinJSBridge.invoke('getBrandWCPayRequest', {
        "appId": wxPayReq.appId, //公众号名称，由商户传入
        "timeStamp": wxPayReq.timeStamp, //时间戳，自1970年以来的秒数
        "nonceStr": wxPayReq.nonceStr, //随机串
        "package": wxPayReq.package,
        "signType": wxPayReq.signType, //微信签名方式：
        "paySign": wxPayReq.paySign //微信签名
      }, function (res) {
        if (res.err_msg === "get_brand_wcpay_request:ok") {
          location.replace(getBackLink(backto, 'success'));
        } else if (res.err_msg === 'get_brand_wcpay_request:cancel') {
          location.replace(getBackLink(backto, 'cancel'));
        } else {
          location.replace(getBackLink(backto, 'wechat pay failed: ' + res.err_msg));
        }
      });
    }

    if (typeof WeixinJSBridge === "undefined") {
      if (document.addEventListener) {
        document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
      } else if (document.attachEvent) {
        document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
        document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
      }
    } else {
      onBridgeReady();
    }
  </script>
</body>
</html>
